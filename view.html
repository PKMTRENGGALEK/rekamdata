<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Skrining Kesehatan</title>

    <!-- Bootstrap & DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        background: linear-gradient(to right, #67b26f, #4ca2cd);
        color: white;
      }
      .container {
        margin-top: 50px;
        text-align: center;
      }
      .card {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .table {
        font-size: 12px;
        text-transform: uppercase;
      }
      .table thead tr {
        background: linear-gradient(to right, #67b26f, #4ca2cd);
        color: white;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loading-spinner {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 10px solid white;
        border-top: 10px solid #67b26f;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .logo-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .logo-container img {
        max-height: 80px;
      }
    </style>
  </head>

  <body>
    <div class="loading-overlay" id="loading">
      <div class="loading-spinner"></div>
    </div>

    <div class="container">
      <div class="logo-container">
        <img src="pkmlogo.png" alt="PKM Logo" />
        <img src="kribo.png" alt="Kribo Logo" />
      </div>
      <h2>Data Skrining TBC</h2>
      <h4>Agen Kribo</h4>

      <!-- Tahun 2025 -->
      <div class="card p-4 mb-4">
        <h5 class="text-white">Data Tahun 2025</h5>
        <div class="table-responsive">
          <table
            id="table2025"
            class="table table-striped table-bordered w-100"
          >
            <thead>
              <tr>
                <th>Faskes</th>
                <th>Tanggal</th>
                <th>Nama</th>
                <th>NIK</th>
                <th>No. Telepon</th>
                <th>Provinsi</th>
                <th>Kabupaten</th>
                <th>Kecamatan</th>
                <th>Kelurahan</th>
                <th>RT</th>
                <th>RW</th>
                <th>Lama Batuk</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="mt-4">
          <h6 class="text-white mb-3">
            Grafik Jumlah Laporan per Faskes (2025)
          </h6>
          <div class="row align-items-center">
            <div class="col-md-8">
              <canvas id="chart2025" style="height: 250px"></canvas>
            </div>
            <div class="col-md-4">
              <ul
                id="list2025"
                class="list-group list-group-flush text-start"
              ></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Tahun 2024 -->
      <div class="card p-4">
        <h5 class="text-white">Data Tahun 2024</h5>
        <div class="table-responsive">
          <table
            id="table2024"
            class="table table-striped table-bordered w-100"
          >
            <thead>
              <tr>
                <th>Faskes</th>
                <th>Tanggal</th>
                <th>Nama</th>
                <th>NIK</th>
                <th>No. Telepon</th>
                <th>Provinsi</th>
                <th>Kabupaten</th>
                <th>Kecamatan</th>
                <th>Kelurahan</th>
                <th>RT</th>
                <th>RW</th>
                <th>Lama Batuk</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="mt-4">
          <h6 class="text-white mb-3">
            Grafik Jumlah Laporan per Faskes (2024)
          </h6>
          <div class="row align-items-center">
            <div class="col-md-8">
              <canvas id="chart2024" style="height: 250px"></canvas>
            </div>
            <div class="col-md-4">
              <ul
                id="list2024"
                class="list-group list-group-flush text-start"
              ></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const GAS_URL =
        "https://script.google.com/macros/s/AKfycbxeMNOb6KnATCyppjqP2rdH7AAMXR-BfKvtutXyi2IdhGGflC7Hi_1mfTqRIlEp6xV-/exec";

      function formatTimestamp(ts) {
        if (!ts) return "-";
        const d = new Date(ts);
        if (isNaN(d)) return ts;
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        return `${dd}-${mm}-${yy}`;
      }

      function renderChart(targetCanvas, targetList, data, year) {
        const count = {};
        data.forEach((r) => {
          const f = r.faskes || "Tidak diketahui";
          count[f] = (count[f] || 0) + 1;
        });

        const labels = Object.keys(count);
        const values = Object.values(count);

        const colors = [
          "rgba(255, 99, 132, 0.7)",
          "rgba(54, 162, 235, 0.7)",
          "rgba(255, 206, 86, 0.7)",
          "rgba(75, 192, 192, 0.7)",
          "rgba(153, 102, 255, 0.7)",
          "rgba(255, 159, 64, 0.7)",
          "rgba(255, 255, 255, 0.6)",
        ];

        new Chart(document.getElementById(targetCanvas), {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: `Jumlah Laporan ${year}`,
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderColor: "#fff",
                borderWidth: 1.5,
                borderRadius: 5,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: "white", font: { size: 10 } } },
              y: {
                beginAtZero: true,
                ticks: { color: "white", font: { size: 10 } },
                grid: { color: "rgba(255,255,255,0.2)" },
              },
            },
          },
        });

        const list = document.getElementById(targetList);
        list.innerHTML = "";
        labels.forEach((lbl, i) => {
          list.innerHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center" 
                style="background:rgba(255,255,255,0.1);color:white;">
              <span>${lbl}</span>
              <span class="badge bg-light text-dark">${values[i]}</span>
            </li>`;
        });
      }

      $(document).ready(() => {
        $("#loading").show();
        $.getJSON(GAS_URL, function (rows) {
          $("#loading").hide();

          // Pisahkan data berdasarkan tahun
          const data2025 = rows.filter(
            (r) => new Date(r.tanggal).getFullYear() === 2025
          );
          const data2024 = rows.filter(
            (r) => new Date(r.tanggal).getFullYear() === 2024
          );

          // Table 2025
          $("#table2025").DataTable({
            data: data2025,
            columns: [
              { data: "faskes" },
              { data: "tanggal", render: formatTimestamp },
              { data: "nama" },
              { data: "nik" },
              { data: "no_telp" },
              { data: "provinsi" },
              { data: "kabupaten" },
              { data: "kecamatan" },
              { data: "kelurahan" },
              { data: "rt" },
              { data: "rw" },
              { data: "lama_batuk" },
            ],
            dom: "Bfrtip",
            buttons: ["excel", "print"],
          });

          // Table 2024
          $("#table2024").DataTable({
            data: data2024,
            columns: [
              { data: "faskes" },
              { data: "tanggal", render: formatTimestamp },
              { data: "nama" },
              { data: "nik" },
              { data: "no_telp" },
              { data: "provinsi" },
              { data: "kabupaten" },
              { data: "kecamatan" },
              { data: "kelurahan" },
              { data: "rt" },
              { data: "rw" },
              { data: "lama_batuk" },
            ],
            dom: "Bfrtip",
            buttons: ["excel", "print"],
          });

          // Tampilkan chart per tahun
          renderChart("chart2025", "list2025", data2025, 2025);
          renderChart("chart2024", "list2024", data2024, 2024);
        });
      });
    </script>
  </body>
</html>
